<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-5QG29TGPBJ"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            
            gtag('config', 'G-5QG29TGPBJ');
            
        </script>
    <link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Functions and operators" href="functions.html" /><link rel="prev" title="Query execution" href="execution.html" />
        <link rel="canonical" href="/manual/tips.html" />

    <meta name="generator" content="sphinx-5.1.1, furo 2022.09.15"/>
        <title>Tips for writing queries - CozoScript</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=9ec31e2665bf879c1d47d93a8ec4893870ee1e45" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">CozoScript</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">CozoScript</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="queries.html">Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="stored.html">Stored relations and transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="timetravel.html">Time travel</a></li>
<li class="toctree-l1"><a class="reference internal" href="sysops.html">System ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="datatypes.html">Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="execution.html">Query execution</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Tips for writing queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="functions.html">Functions and operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="aggregations.html">Aggregations</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">Utilities and algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="nonscript.html">Beyond CozoScript</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="tips-for-writing-queries">
<h1>Tips for writing queries<a class="headerlink" href="#tips-for-writing-queries" title="Permalink to this heading">#</a></h1>
<section id="dealing-with-nulls">
<h2>Dealing with nulls<a class="headerlink" href="#dealing-with-nulls" title="Permalink to this heading">#</a></h2>
<p>Cozo is strict about types. A simple query such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>?[a] := *rel[a, b], b &gt; 0
</pre></div>
</div>
<p>will throw if some of the <code class="docutils literal notranslate"><span class="pre">b</span></code> is null: comparisons can only be made between values of the same type.
There are various ways you can deal with it: if you decide that the condition should be <code class="docutils literal notranslate"><span class="pre">false</span></code> if values are
not of the same type, you write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>?[a] := *rel[a, b], try(b &gt; 0, false)
</pre></div>
</div>
<p>Alternatively, you may decide to consider any <code class="docutils literal notranslate"><span class="pre">null</span></code> values to be equivalent to some default values,
in which case you write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>?[a] := *rel[a, b], (b ~ -1) &gt; 0
</pre></div>
</div>
<p>here <code class="docutils literal notranslate"><span class="pre">~</span></code> is the <code class="docutils literal notranslate"><span class="pre">coalesce</span></code> operator. The parentheses are not necessary, but it reads better this way.
We recommend using the <code class="docutils literal notranslate"><span class="pre">coalesce</span></code> operator over using <code class="docutils literal notranslate"><span class="pre">try</span></code>, since it is more explicit.</p>
<p>You can also be very explicit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>?[a] := *rel[a, b], if(is_null(b), false, b &gt; 0)
</pre></div>
</div>
<p>but this is rather verbose. <code class="docutils literal notranslate"><span class="pre">cond</span></code> is also helpful in this case.</p>
</section>
<section id="how-to-join-relations">
<h2>How to join relations<a class="headerlink" href="#how-to-join-relations" title="Permalink to this heading">#</a></h2>
<p>Suppose we have the following relation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:</span><span class="n">create</span> <span class="n">friend</span> <span class="p">{</span><span class="n">fr</span><span class="p">,</span> <span class="n">to</span><span class="p">}</span>
</pre></div>
</div>
<p>Let’s say we want to find Alice’s friends’ friends’ friends’ friends’ friends. One way to write this is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>?[who] := *friends{fr: &#39;Alice&#39;, to: f1},
          *friends{fr: f1, to: f2},
          *friends{fr: f2, to: f3},
          *friends{fr: f3, to: f4},
          *friends{fr: f4, to: who}
</pre></div>
</div>
<p>Another way is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>f1[who] := *friends{fr: &#39;Alice&#39;, to: who}
f2[who] := f1[fr], *friends{fr, to: who}
f3[who] := f2[fr], *friends{fr, to: who}
f4[who] := f3[fr], *friends{fr, to: who}
?[who] := f4[fr], *friends{fr, to: who}
</pre></div>
</div>
<p>These two queries yield identical values. But on real networks, where loops abound,
the second way of writing executes exponentially faster than the first.
Why? Because of set semantics in relations, the second way of writing deduplicates at every turn,
whereas the first way of writing builds up all paths to the final layer of friends. Depending on
the size of your graph, your computer may not even have enough memory to hold all these paths!</p>
<p>The moral of the story is, always prefer to break your query into smaller rules.
It usually reads better, and unlike in some other databases,
it almost always executes faster in Cozo as well. But for this particular case, in which the query
is largely recursive, prefer to make it a recursive relation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>f_n[who, min(layer)] := *friends{fr: &#39;Alice&#39;, to: who}, layer = 1
f_n[who, min(layer)] := f_n[fr, last_layer], *friends{fr, to: who}, layer = last_layer + 1, layer &lt;= 5
?[who] := f_n[who, 5]
</pre></div>
</div>
<p>The condition <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">&lt;=</span> <span class="pre">5</span></code> is necessary to ensure termination.</p>
<p>Are there any situations where the first way of writing is acceptable? Yes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>?[who] := *friends{fr: &#39;Alice&#39;, to: f1},
          *friends{fr: f1, to: f2},
          *friends{fr: f2, to: f3},
          *friends{fr: f3, to: f4},
          *friends{fr: f4, to: who}
:limit 1
</pre></div>
</div>
<p>in this case, we stop at the first path, and this way of writing avoids the overhead of multiple rules
and is perhaps very slightly faster.</p>
<p>Also, if you want to count the different paths, you must write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>?[count(who)] := *friends{fr: &#39;Alice&#39;, to: f1},
                 *friends{fr: f1, to: f2},
                 *friends{fr: f2, to: f3},
                 *friends{fr: f3, to: f4},
                 *friends{fr: f4, to: who}
</pre></div>
</div>
<p>The multiple-rules way of writing gives wrong results due to set semantics.
Due to the presence of the aggregation <code class="docutils literal notranslate"><span class="pre">count</span></code>, this query only keeps a single path in memory at any instant,
so it won’t blow up your memory even on web-scale data.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="functions.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Functions and operators</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="execution.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Query execution</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Ziyang Hu
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Tips for writing queries</a><ul>
<li><a class="reference internal" href="#dealing-with-nulls">Dealing with nulls</a></li>
<li><a class="reference internal" href="#how-to-join-relations">How to join relations</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/furo.js"></script>
    </body>
</html>