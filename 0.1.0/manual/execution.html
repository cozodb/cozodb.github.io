<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Functions" href="functions.html" /><link rel="prev" title="Datatypes" href="datatypes.html" />
        <link rel="canonical" href="/manual/execution.html" />

    <meta name="generator" content="sphinx-5.1.1, furo 2022.09.15"/>
        <title>Query execution - Cozo Manual</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=9ec31e2665bf879c1d47d93a8ec4893870ee1e45" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Cozo Manual</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">Cozo Manual</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="queries.html">Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="stored.html">Stored relations and transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="sysops.html">System ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="datatypes.html">Datatypes</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Query execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="functions.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="aggregations.html">Aggregations</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">Utilities and algorithms</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="query-execution">
<h1>Query execution<a class="headerlink" href="#query-execution" title="Permalink to this heading">#</a></h1>
<p>Usually, in a database,
how queries are executed is usually considered an implementation detail
hidden behind an abstraction barrier, which normal users need not care about.
The idea is that databases will take advantage of this abstraction barrier
by using query optimizers to choose the best query plan,
regardless of how the query was originally written.
As everyone knows, however, this abstraction barrier is leaky,
since bad query execution plans invariably occur and hurt performance.
The problem is especially severe when dealing with graphs,
since graph traversals generally use a lot more joins than non-graph queries,
and the reliability of even the best query optimizer
decreases exponentially with the number of joins.</p>
<p>In Cozo we take the pragmatic approach and assume that the user eventually
knows (or should know) what is the best way to query their data.
This is certainly true for those developers who spend hours
“coercing” the query optimizers to use a query plan that the user intends,
sometimes in rather convoluted ways.
In Cozo, no coercion is necessary since the query execution is completely
determined by how the query is written:
there is no stats-based query planning involved.
In our experience, this saves quite a lot of developer time,
since developers eventually learn how to write efficient queries naturally,
and after they do, they no longer have to deal with endless “query de-optimizations”.</p>
<section id="stratification">
<h2>Stratification<a class="headerlink" href="#stratification" title="Permalink to this heading">#</a></h2>
<p>As discussed in the chapter on queries, Cozo sees a query as a set of named rules.
Fixed rules are left as they are,
and inline rules are converted into disjunctive normal forms.
After conversion, all inline rules consist of conjunction of atoms only,
and negation only occurs for the leaf atoms.</p>
<p>The next step towards executing the query is <em>stratifying</em> the rules.
Stratification begins by making a graph of the named rules,
with the rules themselves as nodes,
and a link is added between two nodes when one of the rules applies the other.
This application is through atoms for inline rules, and input relations for fixed rules.
Now some of the links are labelled <em>stratifying</em>:
when an inline rule applies another rule through negation,
when an inline rule applies another inline rule that contains aggregations,
when an inline rule applies itself and it has non-semi-lattice,
when an inline rule applies another rule which is a fixed rule,
or when a fixed rule has another rule as an input relation.
The strongly connected components of this graph are then determined and tested,
and if it found that some strongly connected component contains a stratifying link,
the graph is deemed <em>unstratifiable</em>, and the execution aborts.
Otherwise, Cozo will topologically sort the strongly connected components to
determine a <em>stratification</em> of the rules:
rules within the same stratum are logically executed together,
and no two rules within the same stratum can have a stratifying link between them.
In this process,
Cozo will merge the strongly connected components into as few supernodes as possible
while still maintaining the restriction on stratifying links.
The resulting strata are then passed on to be processed in the next step.</p>
<p>You can see the stratum number assigned to rules by using the <code class="docutils literal notranslate"><span class="pre">::explain</span></code> system op.</p>
</section>
<section id="magic-set-rewrites">
<h2>Magic set rewrites<a class="headerlink" href="#magic-set-rewrites" title="Permalink to this heading">#</a></h2>
<p>Within each stratum, the input rules are rewritten using a technique called magic sets.
In intuitive terms, this rewriting is to ensure that the query execution does not
waste time calculating results that are then simply discarded.
As an example, consider:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>reachable[a, b] := link[a, n]
reachable[a, b] := reachable[a, c], link[c, b]
?[r] := reachable[&#39;A&#39;, r]
</pre></div>
</div>
<p>Without magic set rewrites, the whole <code class="docutils literal notranslate"><span class="pre">reachable</span></code> relation is generated first,
then most of them are thrown away, keeping only those starting from <code class="docutils literal notranslate"><span class="pre">'A'</span></code>.
Magic set avoids this problem. How the rewrite proceeds is rather technical,
but you can see the results in the output of <code class="docutils literal notranslate"><span class="pre">::explain</span></code>.</p>
<p>The rewritten query is guaranteed to yield the same relation for <code class="docutils literal notranslate"><span class="pre">?</span></code>,
and will in general yield fewer intermediate rows.</p>
<p>Currently, the rewrite applies only to inline rules without aggregations.
So for the moment being, you may need to manually constrain some of your rules.</p>
</section>
<section id="semi-naive-evaluation">
<h2>Semi-naïve evaluation<a class="headerlink" href="#semi-naive-evaluation" title="Permalink to this heading">#</a></h2>
<p>Now each stratum contains either a single fixed rule or a set of inline rules.
The single fixed rule case is easy: just run the specific implementation of the rule.
In the case of the inline rules, each of the rules is assigned an output relation.
Assuming we know how to evaluate each rule given all the relations it depends on,
the semi-naïve algorithm can now be applied to the rules to yield all output rows.</p>
<p>The semi-naïve algorithm is a bottom-up evaluation strategy, meaning that it tries to deduce
all facts from a set of given facts.
By contrast, top-down strategies start with stated goals and try to find proof for the goals.
Bottom-up strategies have many advantages over top-down ones when the whole output of each rule
is needed, but may waste time generating unused facts if only some of the output is kept.
Magic set rewrites are introduced to eliminate precisely this weakness.</p>
</section>
<section id="ordering-of-atoms">
<h2>Ordering of atoms<a class="headerlink" href="#ordering-of-atoms" title="Permalink to this heading">#</a></h2>
<p>Now we discuss how a single definition of an inline rule is evaluated.
We know from the query chapter that the body of the rule contains atoms,
and after conversion to disjunctive normal forms, all atoms are linked by conjunction,
and each atom can only be one of the following:</p>
<ul class="simple">
<li><p>an explicit unification,</p></li>
<li><p>applying a rule or a stored relation,</p></li>
<li><p>an expression, which should evaluate to a boolean,</p></li>
<li><p>a negation of an application.</p></li>
</ul>
<p>The first two cases may introduce fresh bindings, whereas the last two cannot.
The atoms are then reordered: all atoms that introduce new bindings stay where they are,
whereas all atoms that do not introduce new bindings are moved to the earliest possible place
where all their bindings are bound. In fact,
all atoms that introduce bindings correspond to
joining with a pre-existing relation followed by projections
in relational algebra, and all atoms that do not correspond to filters.
The idea is to apply filters as early as possible
to minimize the number of rows before joining with the next relation.</p>
<p>This procedure is completely deterministic.
When writing the body of rules, we therefore should aim to minimize the total number of rows generated.
A strategy that works almost in all cases is to put the most restrictive atoms which generate new bindings first,
as this can make the left relation in each join small.</p>
</section>
<section id="relations-as-indices">
<h2>Relations as indices<a class="headerlink" href="#relations-as-indices" title="Permalink to this heading">#</a></h2>
<p>Next, we need to understand how a single atom which generates new bindings is processed.</p>
<p>For the case of unification, it is simple: the right-hand side of the unification,
which is an expression with all variables bound, is simply evaluated, and the result is joined
to the current relation (as in a <code class="docutils literal notranslate"><span class="pre">map-cat</span></code> operation in functional languages).</p>
<p>For the case of the application of relations,
the first thing to understand is that all relations in Cozo are conceptually trees.
All the bindings of relations generated by inline or fixed rules,
and the keys of stored relations, act as a composite key for the tree.
The access complexity is therefore determined by whether a key component is bound.
For example, the following application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a_rule</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
</pre></div>
</div>
<p>with <code class="docutils literal notranslate"><span class="pre">c</span></code> unbound is very efficient, since this corresponds to a prefix scan in the tree with the key prefix <code class="docutils literal notranslate"><span class="pre">['A',</span> <span class="pre">'B']</span></code>,
whereas the following application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a_rule</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">a</span></code> is unbound is very expensive, since we must do a full relation scan.
On the other hand, if <code class="docutils literal notranslate"><span class="pre">a</span></code> is bound, then this is only a logarithmic-time check.</p>
<p>For stored relations, you need to check its schema for the order of keys to deduce the complexity.
The system op <code class="docutils literal notranslate"><span class="pre">::explain</span></code> may also give you some information.</p>
</section>
<section id="early-stopping">
<h2>Early stopping<a class="headerlink" href="#early-stopping" title="Permalink to this heading">#</a></h2>
<p>Within each stratum, rows are generated in a streaming fashion.
For the entry rule <code class="docutils literal notranslate"><span class="pre">?</span></code>, if <code class="docutils literal notranslate"><span class="pre">:limit</span></code> is specified as a query option,
a counter is used to monitor how many valid rows are already generated.
If enough rows are generated, the query stops.
Note that this only works when the entry rule is inline,
and when you are <em>not</em> specifying <code class="docutils literal notranslate"><span class="pre">:order</span></code>.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="functions.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Functions</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="datatypes.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Datatypes</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Ziyang Hu
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Query execution</a><ul>
<li><a class="reference internal" href="#stratification">Stratification</a></li>
<li><a class="reference internal" href="#magic-set-rewrites">Magic set rewrites</a></li>
<li><a class="reference internal" href="#semi-naive-evaluation">Semi-naïve evaluation</a></li>
<li><a class="reference internal" href="#ordering-of-atoms">Ordering of atoms</a></li>
<li><a class="reference internal" href="#relations-as-indices">Relations as indices</a></li>
<li><a class="reference internal" href="#early-stopping">Early stopping</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/furo.js"></script>
    </body>
</html>